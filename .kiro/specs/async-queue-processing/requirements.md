# 需求文档

## 介绍

本文档规定了为数据治理平台实现异步队列处理系统的需求。该系统将把当前的同步文件处理架构转换为使用Redis作为消息队列中间件的异步生产者-消费者模型。此增强功能将通过消除大文件上传期间的阻塞操作来改善用户体验，并提供实时进度反馈。

## 术语表

- **Queue_System（队列系统）**: 基于Redis的消息队列基础设施，管理任务分发
- **Producer（生产者）**: 接收文件上传并创建处理任务的Web API端点
- **Consumer（消费者）**: 检索并执行文件处理任务的后台工作进程
- **Task_Manager（任务管理器）**: 负责任务生命周期管理和状态跟踪的服务
- **Progress_Tracker（进度跟踪器）**: 监控并报告实时处理进度的组件
- **File_Processor（文件处理器）**: 处理上传文件的现有数据清洗服务
- **Task_Queue（任务队列）**: 存储待处理任务的Redis List结构
- **Status_Store（状态存储）**: 维护任务状态和进度信息的Redis Hash结构

## 需求

### 需求1：异步文件上传处理

**用户故事：** 作为用户，我希望上传大文件时无需等待处理完成，这样我可以在文件在后台处理时继续使用应用程序。

#### 验收标准

1. 当用户上传文件时，生产者应接受文件，生成唯一任务ID，并立即返回"处理已开始"状态
2. 当文件上传被接受时，生产者应临时存储文件并在任务队列中排队处理任务
3. 当上传API返回时，系统应提供可用于跟踪处理进度的任务ID
4. 当文件上传时，系统应在创建处理任务之前验证文件格式和大小
5. 当生产者创建任务时，任务管理器应在状态存储中将任务状态初始化为"待处理"

### 需求2：Redis队列基础设施

**用户故事：** 作为系统管理员，我希望有一个可靠的消息队列系统，这样文件处理任务可以高效管理并能在系统重启后继续运行。

#### 验收标准

1. 队列系统应使用Redis List数据结构实现FIFO任务队列
2. 当创建任务时，生产者应使用LPUSH操作将任务信息推送到任务队列
3. 当工作进程可用时，消费者应使用带超时的BRPOP操作从任务队列检索任务
4. 当检索到任务时，消费者应在状态存储中将任务状态更新为"处理中"
5. 队列系统应持久化任务信息以在Redis重启后继续运行
6. 当Redis连接失败时，系统应记录错误并使用指数退避算法尝试重连

### 需求3：后台工作进程处理

**用户故事：** 作为系统操作员，我希望后台工作进程独立处理文件，这样Web应用程序在重负载处理期间保持响应。

#### 验收标准

1. 消费者应作为独立于Web API的单独进程运行
2. 当消费者检索到任务时，文件处理器应执行数据清洗工作流
3. 当处理开始时，消费者应使用初始进度信息更新进度跟踪器
4. 当处理成功完成时，消费者应将任务状态更新为"已完成"并存储结果
5. 当处理失败时，消费者应将任务状态更新为"失败"并记录错误详情
6. 消费者应支持优雅关闭而不丢失正在进行的任务
7. 当消费者进程崩溃时，系统应检测被遗弃的任务并标记为重试

### 需求4：实时进度跟踪

**用户故事：** 作为用户，我希望看到文件处理的实时进度，这样我知道需要等待多长时间并可以跟踪完成状态。

#### 验收标准

1. 进度跟踪器应为每个活动任务维护当前进度百分比
2. 当处理进行时，消费者应定期在状态存储中更新进度信息
3. 当客户端请求进度时，系统应返回当前进度百分比、已处理行数和总行数
4. 进度跟踪器应基于已处理行数与文件总行数计算进度
5. 当处理完成时，进度跟踪器应显示100%进度和最终统计信息

### 需求5：状态查询API

**用户故事：** 作为前端应用程序，我希望查询任务状态和进度，这样我可以向用户显示实时更新。

#### 验收标准

1. 系统应提供GET端点`/api/data-cleaning/check-status/{taskId}`用于状态查询
2. 当进行状态查询时，系统应返回任务状态、进度百分比和处理统计信息
3. 当任务待处理时，系统应返回状态"pending"和0%进度
4. 当任务处理中时，系统应返回状态"processing"和当前进度百分比
5. 当任务完成时，系统应返回状态"completed"和100%进度及最终统计信息
6. 当任务失败时，系统应返回状态"failed"和错误消息及部分进度
7. 当查询无效任务ID时，系统应返回"未找到"错误响应

### 需求6：前端进度显示

**用户故事：** 作为用户，我希望看到进度条和状态更新，这样我了解文件处理的当前状态。

#### 验收标准

1. 当文件上传完成时，前端应立即显示从0%开始的进度条
2. 前端应每2秒轮询状态API以更新进度信息
3. 当收到进度更新时，前端应平滑地将进度条动画到新百分比
4. 当处理完成时，前端应显示完成消息并提供下载链接
5. 当处理失败时，前端应显示错误消息并允许重试选项
6. 当任务达到"completed"或"failed"状态时，前端应停止轮询

### 需求7：任务持久化和恢复

**用户故事：** 作为系统管理员，我希望任务能在系统重启后继续运行，这样在维护或故障期间不会丢失处理工作。

#### 验收标准

1. 任务管理器应在Redis中持久化所有任务信息并设置适当的TTL
2. 当系统重启时，消费者应从任务队列恢复处理任务
3. 当消费者在处理期间崩溃时，系统应检测陈旧的"处理中"任务并重置为"待处理"
4. 系统应实现任务超时检测以处理挂起的处理操作
5. 当任务超过最大处理时间时，系统应将其标记为"失败"并显示超时错误

### 需求8：错误处理和重试逻辑

**用户故事：** 作为系统操作员，我希望有强大的错误处理和重试功能，这样临时故障不会导致工作丢失。

#### 验收标准

1. 当Redis连接失败时，系统应使用指数退避算法重试连接直到最大尝试次数
2. 当文件处理因临时问题失败时，系统应支持可配置限制的自动重试
3. 当任务永久失败时，系统应存储错误详情并通知管理员
4. 系统应区分可重试错误（网络问题）和永久错误（无效文件格式）
5. 当超过重试限制时，系统应将任务标记为永久失败

### 需求9：配置和监控

**用户故事：** 作为系统管理员，我希望有可配置的队列参数和监控功能，这样我可以优化性能并排除故障。

#### 验收标准

1. 系统应支持可配置的Redis连接参数（主机、端口、密码、数据库）
2. 系统应支持可配置的队列参数（工作进程数、超时值、重试限制）
3. 系统应提供队列长度、处理吞吐量和错误率的指标
4. 系统应记录所有队列操作以便调试和审计
5. 系统应支持健康检查端点以监控系统状态

### 需求10：向后兼容性

**用户故事：** 作为现有用户，我希望新的异步系统能与现有文件格式和处理规则兼容，这样我的工作流程保持不变。

#### 验收标准

1. 新的异步系统应支持所有现有文件格式（CSV、Excel）而无需修改
2. 文件处理器应使用现有的数据清洗规则和验证逻辑
3. 输出格式和下载功能应与当前系统保持相同
4. 现有API端点应在过渡期间继续工作
5. 存储结果的数据库架构应与现有查询保持兼容
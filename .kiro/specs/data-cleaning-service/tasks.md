# 实现计划: 数据清洗服务

## 概述

本实现计划将数据清洗服务分解为一系列增量式的开发任务。每个任务都建立在前一个任务的基础上，确保代码逐步集成，没有孤立或未连接的代码。实现将使用NestJS框架和TypeScript语言。

## 任务

- [ ] 1. 初始化NestJS项目和基础配置
  - 使用Nest CLI创建新项目
  - 配置TypeScript编译选项
  - 安装必要的依赖包：@nestjs/common, @nestjs/platform-express, @nestjs/typeorm, typeorm, mysql2, multer, xlsx, class-validator, class-transformer
  - 配置环境变量管理（.env文件）
  - 设置基本的项目结构和模块
  - _需求: 所有需求的基础_

- [ ] 2. 配置数据库和创建FileRecord实体
  - [ ] 2.1 配置TypeORM数据库连接
    - 在app.module.ts中配置TypeORM模块
    - 设置数据库连接参数（host, port, username, password, database）
    - 配置自动同步和日志选项
    - _需求: 8.1, 8.2, 8.3, 8.4_

  - [ ] 2.2 创建FileRecord实体
    - 定义FileRecord实体类，包含所有必需字段
    - 添加数据库索引（status, uploadedAt, jobId）
    - 配置字段类型、默认值和约束
    - _需求: 8.1, 8.2, 8.3, 8.4_

  - [ ]* 2.3 编写FileRecord实体的单元测试
    - 测试实体创建和字段验证
    - 测试默认值和时间戳自动生成
    - _需求: 8.1_

- [ ] 3. 实现File Record Service
  - [ ] 3.1 创建FileRecordService
    - 实现createFileRecord方法
    - 实现updateFileStatus方法
    - 实现listFileRecords方法（支持分页和筛选）
    - 实现getFileRecord方法
    - 实现deleteExpiredRecords方法
    - _需求: 8.1, 8.2, 8.3, 8.4_

  - [ ]* 3.2 编写FileRecordService的单元测试
    - 测试记录创建和更新
    - 测试查询和筛选功能
    - 测试边界情况（空结果、无效ID）
    - _需求: 8.1, 8.2, 8.3, 8.4_

  - [ ]* 3.3 编写属性测试：文件列表查询完整性
    - **属性 18: 文件列表查询完整性**
    - **验证需求: 8.3**
    - 生成随机文件记录，验证查询结果包含所有必需字段
    - _需求: 8.3_

  - [ ]* 3.4 编写属性测试：文件列表筛选正确性
    - **属性 19: 文件列表筛选正确性**
    - **验证需求: 8.2**
    - 生成随机文件记录和筛选条件，验证结果满足筛选条件
    - _需求: 8.2_

- [ ] 4. 实现文件上传和验证功能
  - [ ] 4.1 创建FileService
    - 实现validateFile方法（检查文件类型、大小、MIME类型）
    - 实现saveTemporaryFile方法
    - 实现cleanupFile方法
    - 配置Multer存储选项
    - _需求: 1.1, 1.2, 1.3, 1.4_

  - [ ]* 4.2 编写FileService的单元测试
    - 测试有效Excel文件验证
    - 测试无效文件类型拒绝
    - 测试文件大小限制
    - 测试文件保存和清理
    - _需求: 1.1, 1.2, 1.3_

  - [ ]* 4.3 编写属性测试：无效文件拒绝
    - **属性 2: 无效文件拒绝**
    - **验证需求: 1.2**
    - 生成各种非Excel文件，验证系统正确拒绝
    - _需求: 1.2_

  - [ ]* 4.4 编写属性测试：文件大小限制
    - **属性 3: 文件大小限制**
    - **验证需求: 1.3**
    - 生成超过大小限制的文件，验证系统拒绝
    - _需求: 1.3_

- [ ] 5. 实现Excel解析功能
  - [ ] 5.1 创建ParserService
    - 实现parseExcelFile方法（使用xlsx库）
    - 实现sheetToJson方法
    - 实现identifyColumnTypes方法（识别手机号、日期、地址字段）
    - 处理多工作表Excel文件
    - _需求: 2.1, 2.2, 2.3, 2.4_

  - [ ]* 5.2 编写ParserService的单元测试
    - 测试单工作表解析
    - 测试多工作表解析
    - 测试空文件和损坏文件处理
    - 测试字段类型识别
    - _需求: 2.1, 2.2, 2.3, 2.4_

  - [ ]* 5.3 编写属性测试：Excel解析完整性
    - **属性 4: Excel解析完整性**
    - **验证需求: 2.1**
    - 生成包含已知数据的Excel文件，验证解析后数据行数正确
    - _需求: 2.1_

  - [ ]* 5.4 编写属性测试：多工作表处理
    - **属性 5: 多工作表处理**
    - **验证需求: 2.2**
    - 生成包含多个工作表的Excel文件，验证所有工作表都被处理
    - _需求: 2.2_

- [ ] 6. 检查点 - 确保基础功能正常
  - 确保所有测试通过，如有问题请询问用户

- [ ] 7. 实现手机号清洗功能
  - [ ] 7.1 创建PhoneCleanerService
    - 实现cleanPhone方法（移除空格、横杠、非数字字符）
    - 实现validatePhone私有方法（验证长度和格式）
    - 处理中国手机号（11位）和固定电话（7-12位）
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

  - [ ]* 7.2 编写PhoneCleanerService的单元测试
    - 测试特定格式的手机号清洗
    - 测试无效手机号标记
    - 测试空值和null处理
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

  - [ ]* 7.3 编写属性测试：手机号字符清洗
    - **属性 7: 手机号字符清洗**
    - **验证需求: 3.1, 3.2, 3.3**
    - 生成包含各种非数字字符的手机号，验证清洗后只包含纯数字
    - _需求: 3.1, 3.2, 3.3_

  - [ ]* 7.4 编写属性测试：手机号长度验证
    - **属性 8: 手机号长度验证**
    - **验证需求: 3.4**
    - 生成各种长度的数字串，验证无效长度被标记为异常
    - _需求: 3.4_

- [ ] 8. 实现日期清洗功能
  - [ ] 8.1 创建DateCleanerService
    - 实现cleanDate方法
    - 实现parseDate私有方法（支持多种日期格式）
    - 实现formatDate私有方法（格式化为YYYY-MM-DD）
    - 支持ISO格式、中文格式、美式格式、Excel序列号
    - 验证日期范围（1900-2100）
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

  - [ ]* 8.2 编写DateCleanerService的单元测试
    - 测试各种日期格式转换
    - 测试无效日期标记
    - 测试日期范围验证
    - 测试空值和null处理
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

  - [ ]* 8.3 编写属性测试：日期格式标准化
    - **属性 9: 日期格式标准化**
    - **验证需求: 4.1, 4.2**
    - 生成各种格式的有效日期，验证都能转换为YYYY-MM-DD格式
    - _需求: 4.1, 4.2_

  - [ ]* 8.4 编写属性测试：无效日期标记
    - **属性 10: 无效日期标记**
    - **验证需求: 4.3, 4.5**
    - 生成无效日期和超出范围的日期，验证被标记为异常
    - _需求: 4.3, 4.5_

- [ ] 9. 实现地址清洗功能
  - [ ] 9.1 创建AddressCleanerService
    - 实现cleanAddress方法
    - 实现extractComponents私有方法（提取省市区）
    - 实现matchProvinceCity私有方法（正则匹配）
    - 创建中国行政区划数据（省、市、区列表）
    - 处理直辖市、自治区、特别行政区等特殊情况
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [ ]* 9.2 编写AddressCleanerService的单元测试
    - 测试完整地址解析
    - 测试长地址文本提取
    - 测试无效地址标记
    - 测试特殊地址格式（直辖市等）
    - 测试空值和null处理
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [ ]* 9.3 编写属性测试：地址解析提取
    - **属性 11: 地址解析提取**
    - **验证需求: 5.1, 5.2, 5.5**
    - 生成包含省市区的地址，验证提取的准确性
    - _需求: 5.1, 5.2, 5.5_

  - [ ]* 9.4 编写属性测试：无效地址标记
    - **属性 12: 无效地址标记**
    - **验证需求: 5.3**
    - 生成无效或不完整的地址，验证被标记为异常
    - _需求: 5.3_

- [ ] 10. 实现数据清洗协调服务
  - [ ] 10.1 创建DataCleanerService
    - 实现cleanData方法（协调所有清洗器）
    - 实现cleanRow方法（处理单行数据）
    - 集成PhoneCleanerService、DateCleanerService、AddressCleanerService
    - 生成CleaningResult（包含清洁数据和异常数据）
    - 计算处理统计信息
    - _需求: 3.1-3.5, 4.1-4.5, 5.1-5.5_

  - [ ]* 10.2 编写DataCleanerService的单元测试
    - 测试完整数据清洗流程
    - 测试异常数据分离
    - 测试统计信息计算
    - _需求: 3.1-3.5, 4.1-4.5, 5.1-5.5_

  - [ ]* 10.3 编写属性测试：统计报告完整性
    - **属性 16: 统计报告完整性**
    - **验证需求: 9.2, 9.3**
    - 验证统计报告包含所有必需字段，且总行数=清洁行数+异常行数
    - _需求: 9.2, 9.3_

- [ ] 11. 检查点 - 确保数据清洗功能正常
  - 确保所有测试通过，如有问题请询问用户

- [ ] 12. 实现文件导出功能
  - [ ] 12.1 创建ExportService
    - 实现exportCleanData方法
    - 实现exportExceptionData方法（包含异常原因列）
    - 实现generateExcel私有方法（使用xlsx库）
    - 处理地址字段拆分（省、市、区、详细地址）
    - 保持原始字段顺序
    - _需求: 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3, 7.4_

  - [ ]* 12.2 编写ExportService的单元测试
    - 测试清洁数据导出
    - 测试异常数据导出
    - 测试空数据处理
    - 测试Excel文件生成
    - _需求: 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3, 7.4_

  - [ ]* 12.3 编写属性测试：清洁数据导出结构保持
    - **属性 13: 清洁数据导出结构保持**
    - **验证需求: 6.2**
    - 验证导出的Excel文件保持原有字段顺序和数据结构
    - _需求: 6.2_

  - [ ]* 12.4 编写属性测试：异常数据完整性
    - **属性 15: 异常数据完整性**
    - **验证需求: 7.2, 7.3**
    - 验证导出的异常数据包含原始数据和明确的异常原因
    - _需求: 7.2, 7.3_

- [ ] 13. 实现Controller和API端点
  - [ ] 13.1 创建DataCleaningController
    - 实现POST /upload端点（文件上传）
    - 实现GET /status/:jobId端点（查询处理状态）
    - 实现GET /files端点（查询文件列表）
    - 实现GET /files/:fileId端点（查询文件详情）
    - 实现GET /download/clean/:jobId端点（下载清洁数据）
    - 实现GET /download/exceptions/:jobId端点（下载异常数据）
    - 配置Multer拦截器
    - 添加请求验证（使用class-validator）
    - _需求: 1.1-1.4, 6.1-6.4, 7.1-7.4, 8.1-8.4, 9.1-9.4_

  - [ ] 13.2 创建DTO类
    - 创建ListFilesDto（查询参数验证）
    - 创建UploadResponse、StatusResponse、FileListResponse、FileDetailResponse
    - 添加验证装饰器
    - _需求: 8.1-8.4_

  - [ ]* 13.3 编写Controller的单元测试
    - 测试所有API端点
    - 测试请求验证
    - 测试错误处理
    - _需求: 1.1-1.4, 6.1-6.4, 7.1-7.4, 8.1-8.4, 9.1-9.4_

  - [ ]* 13.4 编写属性测试：有效Excel文件接受
    - **属性 1: 有效Excel文件接受**
    - **验证需求: 1.1, 1.4**
    - 生成随机有效Excel文件，验证上传成功并返回有效jobId
    - _需求: 1.1, 1.4_

  - [ ]* 13.5 编写属性测试：导出文件有效性
    - **属性 14: 导出文件有效性**
    - **验证需求: 6.3**
    - 验证所有导出请求返回有效的Excel文件流
    - _需求: 6.3_

- [ ] 14. 实现全局异常处理和日志
  - [ ] 14.1 创建全局异常过滤器
    - 实现HttpExceptionFilter
    - 统一错误响应格式
    - 添加错误日志记录
    - _需求: 所有需求的错误处理_

  - [ ] 14.2 创建自定义异常类
    - 创建业务异常类（FileValidationException, ParseException等）
    - 定义错误码常量
    - _需求: 所有需求的错误处理_

  - [ ] 14.3 配置日志系统
    - 配置NestJS Logger
    - 添加请求日志中间件
    - 配置日志级别和输出格式
    - _需求: 所有需求的日志记录_

- [ ] 15. 集成测试和端到端测试
  - [ ]* 15.1 编写集成测试
    - 测试完整的数据处理流程（上传→解析→清洗→导出）
    - 测试数据库操作
    - 测试文件系统操作
    - _需求: 所有需求_

  - [ ]* 15.2 编写端到端测试
    - 测试所有API端点的完整流程
    - 使用真实的Excel文件样本
    - 验证数据完整性
    - _需求: 所有需求_

- [ ] 16. 最终检查点
  - 确保所有测试通过，如有问题请询问用户
  - 验证所有功能正常工作
  - 检查代码质量和文档完整性

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况

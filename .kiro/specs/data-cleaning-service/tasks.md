# 实现计划: 数据清洗服务

## 概述

本实现计划将数据清洗服务分解为一系列增量式的开发任务。每个任务都建立在前一个任务的基础上，确保代码逐步集成，没有孤立或未连接的代码。实现将使用NestJS框架和TypeScript语言。

## 任务

- [x] 1. 初始化NestJS项目和基础配置
  - 使用Nest CLI创建新项目
  - 配置TypeScript编译选项
  - 安装必要的依赖包：@nestjs/common, @nestjs/platform-express, @nestjs/typeorm, typeorm, mysql2, multer, xlsx, class-validator, class-transformer
  - 配置环境变量管理（.env文件）
  - 设置基本的项目结构和模块
  - _需求: 所有需求的基础_

- [x] 2. 配置数据库和创建FileRecord实体
  - [x] 2.1 配置TypeORM数据库连接
    - 在app.module.ts中配置TypeORM模块
    - 设置数据库连接参数（host, port, username, password, database）
    - 配置自动同步和日志选项
    - _需求: 8.1, 8.2, 8.3, 8.4_

  - [x] 2.2 创建FileRecord实体
    - 定义FileRecord实体类，包含所有必需字段
    - 添加数据库索引（status, uploadedAt, jobId）
    - 配置字段类型、默认值和约束
    - _需求: 8.1, 8.2, 8.3, 8.4_

  - [x] 2.3 编写FileRecord实体的单元测试
    - 测试实体创建和字段验证
    - 测试默认值和时间戳自动生成
    - _需求: 8.1_

- [x] 3. 实现File Record Service
  - [x] 3.1 创建FileRecordService
    - 实现createFileRecord方法
    - 实现updateFileStatus方法
    - 实现listFileRecords方法（支持分页和筛选）
    - 实现getFileRecord方法
    - 实现deleteExpiredRecords方法
    - _需求: 8.1, 8.2, 8.3, 8.4_

  - [x] 3.2 编写FileRecordService的单元测试
    - 测试记录创建和更新
    - 测试查询和筛选功能
    - 测试边界情况（空结果、无效ID）
    - _需求: 8.1, 8.2, 8.3, 8.4_

  - [x] 3.3 编写属性测试：文件列表查询完整性
    - **属性 18: 文件列表查询完整性**
    - **验证需求: 8.3**
    - 生成随机文件记录，验证查询结果包含所有必需字段
    - _需求: 8.3_

  - [x] 3.4 编写属性测试：文件列表筛选正确性
    - **属性 19: 文件列表筛选正确性**
    - **验证需求: 8.2**
    - 生成随机文件记录和筛选条件，验证结果满足筛选条件
    - _需求: 8.2_

- [x] 4. 创建基础DTO和API结构
  - [x] 4.1 创建所有响应DTO类
    - 创建UploadResponseDto、StatusResponseDto、FileListResponseDto、FileDetailResponseDto、ErrorResponseDto
    - 添加Swagger文档注解
    - _需求: 8.1-8.4_

  - [x] 4.2 创建DataCleaningController骨架
    - 实现所有API端点的基础结构
    - 添加Swagger文档和验证装饰器
    - 添加示例响应数据
    - _需求: 1.1-1.4, 6.1-6.4, 7.1-7.4, 8.1-8.4, 9.1-9.4_

- [ ] 5. 实现文件上传和验证功能
  - [x] 5.1 创建FileService
    - 实现validateFile方法（检查文件类型、大小、MIME类型）
    - 实现saveTemporaryFile方法
    - 实现cleanupFile方法
    - 配置Multer存储选项
    - _需求: 1.1, 1.2, 1.3, 1.4_

  - [x] 5.2 编写FileService的单元测试

    - 测试有效Excel文件验证
    - 测试无效文件类型拒绝
    - 测试文件大小限制
    - 测试文件保存和清理
    - _需求: 1.1, 1.2, 1.3_

  - [x] 5.3 编写属性测试：无效文件拒绝

    - **属性 2: 无效文件拒绝**
    - **验证需求: 1.2**
    - 生成各种非Excel文件，验证系统正确拒绝
    - _需求: 1.2_

  - [x] 5.4 编写属性测试：文件大小限制

    - **属性 3: 文件大小限制**
    - **验证需求: 1.3**
    - 生成超过大小限制的文件，验证系统拒绝
    - _需求: 1.3_

- [-] 6. 实现Excel解析功能
  - [x] 6.1 创建ParserService
    - 实现parseExcelFile方法（使用xlsx库）
    - 实现sheetToJson方法
    - 实现identifyColumnTypes方法（识别手机号、日期、地址字段）
    - 处理多工作表Excel文件
    - _需求: 2.1, 2.2, 2.3, 2.4_

  - [ ]* 6.2 编写ParserService的单元测试
    - 测试单工作表解析
    - 测试多工作表解析
    - 测试空文件和损坏文件处理
    - 测试字段类型识别
    - _需求: 2.1, 2.2, 2.3, 2.4_

  - [ ]* 6.3 编写属性测试：Excel解析完整性
    - **属性 4: Excel解析完整性**
    - **验证需求: 2.1**
    - 生成包含已知数据的Excel文件，验证解析后数据行数正确
    - _需求: 2.1_

  - [ ]* 6.4 编写属性测试：多工作表处理
    - **属性 5: 多工作表处理**
    - **验证需求: 2.2**
    - 生成包含多个工作表的Excel文件，验证所有工作表都被处理
    - _需求: 2.2_

- [ ] 7. 检查点 - 确保基础功能正常
  - 确保所有测试通过，如有问题请询问用户

- [x] 8. 实现手机号清洗功能
  - [x] 8.1 创建PhoneCleanerService
    - 实现cleanPhone方法（移除空格、横杠、非数字字符）
    - 实现validatePhone私有方法（验证长度和格式）
    - 处理中国手机号（11位）和固定电话（7-12位）
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

  - [x] 8.2 编写PhoneCleanerService的单元测试


    - 测试特定格式的手机号清洗
    - 测试无效手机号标记
    - 测试空值和null处理
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

  - [x] 8.3 编写属性测试：手机号字符清洗

    - **属性 7: 手机号字符清洗**
    - **验证需求: 3.1, 3.2, 3.3**
    - 生成包含各种非数字字符的手机号，验证清洗后只包含纯数字
    - _需求: 3.1, 3.2, 3.3_

  - [ ]* 8.4 编写属性测试：手机号长度验证
    - **属性 8: 手机号长度验证**
    - **验证需求: 3.4**
    - 生成各种长度的数字串，验证无效长度被标记为异常
    - _需求: 3.4_

- [-] 9. 实现日期清洗功能
  - [x] 9.1 创建DateCleanerService
    - 实现cleanDate方法
    - 实现parseDate私有方法（支持多种日期格式）
    - 实现formatDate私有方法（格式化为YYYY-MM-DD）
    - 支持ISO格式、中文格式、美式格式、Excel序列号
    - 验证日期范围（1900-2100）
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

  - [ ]* 9.2 编写DateCleanerService的单元测试
    - 测试各种日期格式转换
    - 测试无效日期标记
    - 测试日期范围验证
    - 测试空值和null处理
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

  - [ ]* 9.3 编写属性测试：日期格式标准化
    - **属性 9: 日期格式标准化**
    - **验证需求: 4.1, 4.2**
    - 生成各种格式的有效日期，验证都能转换为YYYY-MM-DD格式
    - _需求: 4.1, 4.2_

  - [ ]* 9.4 编写属性测试：无效日期标记
    - **属性 10: 无效日期标记**
    - **验证需求: 4.3, 4.5**
    - 生成无效日期和超出范围的日期，验证被标记为异常
    - _需求: 4.3, 4.5_

- [-] 10. 实现地址清洗功能
  - [x] 10.1 创建AddressCleanerService
    - 实现cleanAddress方法
    - 实现extractComponents私有方法（提取省市区）
    - 实现matchProvinceCity私有方法（正则匹配）
    - 创建中国行政区划数据（省、市、区列表）
    - 处理直辖市、自治区、特别行政区等特殊情况
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [ ]* 10.2 编写AddressCleanerService的单元测试
    - 测试完整地址解析
    - 测试长地址文本提取
    - 测试无效地址标记
    - 测试特殊地址格式（直辖市等）
    - 测试空值和null处理
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [ ]* 10.3 编写属性测试：地址解析提取
    - **属性 11: 地址解析提取**
    - **验证需求: 5.1, 5.2, 5.5**
    - 生成包含省市区的地址，验证提取的准确性
    - _需求: 5.1, 5.2, 5.5_

  - [ ]* 10.4 编写属性测试：无效地址标记
    - **属性 12: 无效地址标记**
    - **验证需求: 5.3**
    - 生成无效或不完整的地址，验证被标记为异常
    - _需求: 5.3_

- [x] 11. 实现数据清洗协调服务
  - [x] 11.1 创建DataCleanerService
    - 实现cleanData方法（协调所有清洗器）
    - 实现cleanRow方法（处理单行数据）
    - 集成PhoneCleanerService、DateCleanerService、AddressCleanerService
    - 生成CleaningResult（包含清洁数据和异常数据）
    - 计算处理统计信息
    - _需求: 3.1-3.5, 4.1-4.5, 5.1-5.5_

  - [ ]* 11.2 编写DataCleanerService的单元测试
    - 测试完整数据清洗流程
    - 测试异常数据分离
    - 测试统计信息计算
    - _需求: 3.1-3.5, 4.1-4.5, 5.1-5.5_

  - [ ]* 11.3 编写属性测试：统计报告完整性
    - **属性 16: 统计报告完整性**
    - **验证需求: 9.2, 9.3**
    - 验证统计报告包含所有必需字段，且总行数=清洁行数+异常行数
    - _需求: 9.2, 9.3_

- [ ] 12. 检查点 - 确保数据清洗功能正常
  - 确保所有测试通过，如有问题请询问用户

- [-] 13. 实现文件导出功能
  - [x] 13.1 创建ExportService
    - 实现exportCleanData方法
    - 实现exportExceptionData方法（包含异常原因列）
    - 实现generateExcel私有方法（使用xlsx库）
    - 处理地址字段拆分（省、市、区、详细地址）
    - 保持原始字段顺序
    - _需求: 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3, 7.4_

  - [ ]* 13.2 编写ExportService的单元测试
    - 测试清洁数据导出
    - 测试异常数据导出
    - 测试空数据处理
    - 测试Excel文件生成
    - _需求: 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3, 7.4_

  - [ ]* 13.3 编写属性测试：清洁数据导出结构保持
    - **属性 13: 清洁数据导出结构保持**
    - **验证需求: 6.2**
    - 验证导出的Excel文件保持原有字段顺序和数据结构
    - _需求: 6.2_

  - [ ]* 13.4 编写属性测试：异常数据完整性
    - **属性 15: 异常数据完整性**
    - **验证需求: 7.2, 7.3**
    - 验证导出的异常数据包含原始数据和明确的异常原因
    - _需求: 7.2, 7.3_

- [-] 14. 连接Controller与实际服务
  - [x] 14.1 更新DataCleaningController实现
    - 连接FileRecordService到Controller
    - 实现真实的文件上传处理逻辑
    - 集成FileService、ParserService、DataCleanerService、ExportService
    - 添加错误处理和状态管理
    - _需求: 1.1-1.4, 6.1-6.4, 7.1-7.4, 8.1-8.4, 9.1-9.4_

  - [ ]* 14.2 编写Controller的集成测试
    - 测试完整的API流程
    - 测试错误处理
    - 测试文件上传和下载
    - _需求: 1.1-1.4, 6.1-6.4, 7.1-7.4, 8.1-8.4, 9.1-9.4_

  - [ ]* 14.3 编写属性测试：有效Excel文件接受
    - **属性 1: 有效Excel文件接受**
    - **验证需求: 1.1, 1.4**
    - 生成随机有效Excel文件，验证上传成功并返回有效jobId
    - _需求: 1.1, 1.4_

  - [ ]* 14.4 编写属性测试：导出文件有效性
    - **属性 14: 导出文件有效性**
    - **验证需求: 6.3**
    - 验证所有导出请求返回有效的Excel文件流
    - _需求: 6.3_

- [ ] 15. 实现全局异常处理和日志
  - [ ] 15.1 创建全局异常过滤器
    - 实现HttpExceptionFilter
    - 统一错误响应格式
    - 添加错误日志记录
    - _需求: 所有需求的错误处理_

  - [ ] 15.2 创建自定义异常类
    - 创建业务异常类（FileValidationException, ParseException等）
    - 定义错误码常量
    - _需求: 所有需求的错误处理_

  - [ ] 15.3 配置日志系统
    - 配置NestJS Logger
    - 添加请求日志中间件
    - 配置日志级别和输出格式
    - _需求: 所有需求的日志记录_

- [ ] 16. 端到端测试和最终集成
  - [ ]* 16.1 编写端到端测试
    - 测试完整的数据处理流程（上传→解析→清洗→导出）
    - 使用真实的Excel文件样本
    - 验证数据完整性
    - _需求: 所有需求_

  - [ ]* 16.2 编写剩余属性测试
    - **属性 6: 字段类型识别** - 验证需求: 2.4
    - **属性 17: 状态查询有效性** - 验证需求: 9.4
    - **属性 20: 文件详情查询有效性** - 验证需求: 8.4
    - _需求: 2.4, 8.4, 9.4_

- [ ] 17. 最终检查点
  - 确保所有测试通过，如有问题请询问用户
  - 验证所有功能正常工作
  - 检查代码质量和文档完整性

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况


## 迭代任务：流式处理和数据库持久化

- [-] 18. 创建数据库实体（CleanData和ErrorLog）
  - [x] 18.1 创建CleanData实体
    - 定义CleanData实体类，包含所有清洗后的字段
    - 添加数据库索引（jobId, rowNumber）
    - 配置字段类型、默认值和约束
    - _需求: 11.1, 11.3_

  - [x] 18.2 创建ErrorLog实体
    - 定义ErrorLog实体类，包含错误信息字段
    - 添加数据库索引（jobId, rowNumber）
    - 配置JSON字段存储原始数据和错误详情
    - _需求: 11.2, 11.4_

  - [ ]* 18.3 编写实体的单元测试
    - 测试实体创建和字段验证
    - 测试JSON字段的序列化和反序列化
    - _需求: 11.1, 11.2_

- [x] 19. 实现Database Persistence Service
  - [x] 19.1 创建DatabasePersistenceService
    - 实现batchInsertCleanData方法（批量插入清洁数据）
    - 实现batchInsertErrorLogs方法（批量插入错误日志）
    - 实现getCleanDataByJobId方法
    - 实现getErrorLogsByJobId方法
    - 实现verifyDataIntegrity方法（验证数据完整性）
    - 配置批次大小为1000条
    - 使用TypeORM的createQueryBuilder进行批量插入
    - _需求: 11.1, 11.2, 11.3, 11.4, 11.5, 12.1, 12.2, 12.5_

  - [ ]* 19.2 编写DatabasePersistenceService的单元测试
    - 测试单批次插入
    - 测试多批次插入
    - 测试事务回滚
    - 测试数据完整性验证
    - _需求: 11.1, 11.2, 11.5, 12.2, 12.3_

  - [ ]* 19.3 编写属性测试：清洁数据数据库持久化
    - **属性 24: 清洁数据数据库持久化**
    - **验证需求: 11.1, 11.3**
    - 生成随机清洁数据，插入数据库，验证能查询到完整记录
    - _需求: 11.1, 11.3_

  - [ ]* 19.4 编写属性测试：错误日志数据库持久化
    - **属性 25: 错误日志数据库持久化**
    - **验证需求: 11.2, 11.4**
    - 生成随机错误数据，插入数据库，验证能查询到完整记录
    - _需求: 11.2, 11.4_

  - [ ]* 19.5 编写属性测试：数据完整性不变量
    - **属性 26: 数据完整性不变量**
    - **验证需求: 11.5**
    - 验证clean_data记录数 + error_logs记录数 = 输入总行数
    - _需求: 11.5_

  - [ ]* 19.6 编写属性测试：批量插入成功计数
    - **属性 27: 批量插入成功计数**
    - **验证需求: 12.5**
    - 验证返回的成功计数等于实际插入的记录数
    - _需求: 12.5_

- [-] 20. 实现CSV Parser Service
  - [-] 20.1 创建CsvParserService
    - 安装csv-parser或fast-csv依赖
    - 实现parseCsvFile方法（非流式，用于小文件）
    - 实现parseCsvStream方法（流式处理）
    - 实现detectEncoding方法（检测文件编码）
    - 实现detectDelimiter方法（检测分隔符）
    - 处理UTF-8 BOM、GBK、GB2312编码
    - 处理逗号、分号、制表符分隔符
    - _需求: 1.2, 2.2, 2.5_

  - [ ]* 20.2 编写CsvParserService的单元测试
    - 测试不同编码的CSV文件
    - 测试不同分隔符的CSV文件
    - 测试带引号的字段
    - 测试字段内换行符
    - _需求: 1.2, 2.2_

  - [ ]* 20.3 编写属性测试：CSV文件接受
    - **属性 21: CSV文件接受**
    - **验证需求: 1.2**
    - 生成随机CSV文件，验证上传成功并返回有效jobId
    - _需求: 1.2_

  - [ ]* 20.4 编写属性测试：CSV解析完整性
    - **属性 22: CSV解析完整性**
    - **验证需求: 2.2**
    - 生成包含已知数据的CSV文件，验证解析后行数正确
    - _需求: 2.2_

- [ ] 21. 实现Stream Parser Service
  - [ ] 21.1 创建StreamParserService
    - 安装exceljs或xlsx-stream-reader依赖
    - 实现parseExcelStream方法（流式解析Excel）
    - 实现parseCsvStream方法（流式解析CSV）
    - 实现identifyColumnTypes方法（识别列类型）
    - 使用回调函数逐行处理数据
    - 维护处理统计信息（总行数、处理行数、错误行数）
    - _需求: 2.1, 2.2, 2.5, 10.1, 10.2, 10.4, 10.5_

  - [ ]* 21.2 编写StreamParserService的单元测试
    - 测试小文件流式处理
    - 测试大文件流式处理（使用测试数据生成器）
    - 测试单行错误不中断处理
    - 测试统计信息准确性
    - _需求: 10.4, 10.5_

  - [ ]* 21.3 编写属性测试：流式处理错误恢复
    - **属性 23: 流式处理错误恢复**
    - **验证需求: 10.5**
    - 生成包含错误行的文件，验证错误行被记录且后续行继续处理
    - _需求: 10.5_

- [ ] 22. 检查点 - 确保新服务正常工作
  - 确保所有测试通过，如有问题请询问用户
  - 验证数据库实体创建成功
  - 验证批量插入功能正常
  - 验证CSV解析功能正常
  - 验证流式处理功能正常

- [ ] 23. 更新FileService支持CSV文件
  - [ ] 23.1 更新FileService的validateFile方法
    - 添加CSV文件类型验证（.csv）
    - 添加CSV MIME类型验证（text/csv, application/csv）
    - 更新文件大小限制（支持更大的文件）
    - _需求: 1.2, 1.3, 1.4_

  - [ ]* 23.2 更新FileService的单元测试
    - 测试CSV文件验证
    - 测试CSV文件保存
    - _需求: 1.2_

- [ ] 24. 集成流式处理和数据库持久化到DataCleanerService
  - [ ] 24.1 重构DataCleanerService
    - 修改cleanData方法，使用流式处理
    - 集成StreamParserService
    - 集成DatabasePersistenceService
    - 实现逐行处理逻辑：解析 → 清洗 → 累积到批次 → 批量插入
    - 实现批次管理：达到1000条时触发批量插入
    - 实现错误处理：单行错误不影响后续处理
    - 更新统计信息收集
    - _需求: 10.1, 10.2, 10.4, 10.5, 11.1, 11.2, 12.1, 12.2_

  - [ ]* 24.2 编写集成测试
    - 测试完整流程：上传 → 流式解析 → 清洗 → 批量插入 → 验证数据库
    - 测试小文件（100行）
    - 测试中等文件（10000行）
    - 测试大文件（100000行）
    - 验证数据完整性
    - _需求: 10.4, 11.5_

- [ ] 25. 更新ExportService从数据库读取数据
  - [ ] 25.1 修改ExportService
    - 修改exportCleanData方法，从数据库读取clean_data
    - 修改exportExceptionData方法，从数据库读取error_logs
    - 保持原有的Excel生成逻辑
    - 添加分页查询支持（避免一次性加载大量数据）
    - _需求: 6.1, 6.2, 6.3, 7.1, 7.2, 7.3_

  - [ ]* 25.2 更新ExportService的单元测试
    - 测试从数据库导出清洁数据
    - 测试从数据库导出异常数据
    - 测试大数据量导出（分页）
    - _需求: 6.1, 7.1_

- [ ] 26. 更新DataCleaningController
  - [ ] 26.1 更新Controller的uploadFile方法
    - 支持CSV文件上传
    - 根据文件类型选择解析器（Excel或CSV）
    - 使用流式处理和数据库持久化
    - 更新响应格式
    - _需求: 1.1, 1.2, 1.4, 10.1, 11.1, 11.2_

  - [ ] 26.2 更新Controller的下载方法
    - 修改downloadClean方法，从数据库读取数据
    - 修改downloadExceptions方法，从数据库读取数据
    - _需求: 6.1, 7.1_

  - [ ]* 26.3 编写Controller的集成测试
    - 测试CSV文件上传和处理
    - 测试Excel文件上传和处理
    - 测试从数据库下载清洁数据
    - 测试从数据库下载异常数据
    - _需求: 1.1, 1.2, 6.1, 7.1_

- [ ] 27. 性能测试和优化
  - [ ]* 27.1 编写性能测试
    - 测试100MB文件处理
    - 测试500万行数据处理
    - 监控内存占用（应<500MB）
    - 监控处理时间（100万条<60秒）
    - _需求: 10.3, 12.4_

  - [ ]* 27.2 编写压力测试
    - 使用50MB重复生成的大CSV文件
    - 验证不会出现OutOfMemory错误
    - 验证数据库记录总数等于CSV总行数
    - _需求: 10.3, 11.5_

  - [ ] 27.3 性能优化（如果需要）
    - 调整批次大小
    - 优化数据库索引
    - 优化内存使用
    - _需求: 10.3, 12.4_

- [ ] 28. 最终检查点
  - 确保所有测试通过，如有问题请询问用户
  - 验证所有新功能正常工作
  - 验证流式处理不会内存溢出
  - 验证数据库持久化正确
  - 验证批量插入性能达标
  - 检查代码质量和文档完整性

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
- 迭代任务建立在原有功能基础上，不破坏现有代码

# 需求文档：动态字段映射

## 介绍

动态字段映射功能允许系统自动识别上传文件的表头字段，并根据字段名称或内容特征自动映射到系统的标准字段（姓名、手机号、地址、入职日期等）。这样用户可以上传不同格式的文件，系统能够智能识别并正确处理数据。

## 术语表

- **System**: 数据清洗服务系统
- **Header_Row**: 文件的第一行，包含字段名称
- **Field_Mapping**: 将源文件字段映射到系统标准字段的对应关系
- **Standard_Field**: 系统定义的标准字段（name, phone, address, hireDate, province, city, district）
- **Source_Field**: 源文件中的字段名称
- **Field_Recognition**: 字段识别，通过字段名称或内容特征识别字段类型
- **Mapping_Rule**: 映射规则，定义如何识别和映射字段
- **Column_Index**: 列索引，字段在文件中的位置（从0开始）
- **Data_Sample**: 数据样本，用于辅助字段类型识别的前几行数据

## 需求

### 需求 1：自动识别表头字段

**用户故事：** 作为用户，我想要系统自动识别上传文件的表头字段，以便系统能够处理不同格式的文件。

#### 验收标准

1. 当系统读取文件时，系统应当将第一行识别为表头行
2. 当表头行包含字段名称时，系统应当提取所有字段名称
3. 当表头字段为中文时，系统应当正确识别中文字段名
4. 当表头字段为英文时，系统应当正确识别英文字段名
5. 当表头字段包含空格或特殊字符时，系统应当进行标准化处理（去除空格、转小写）

### 需求 2：智能字段映射

**用户故事：** 作为用户，我想要系统根据字段名称自动映射到标准字段，以便系统能够正确处理数据。

#### 验收标准

1. 当表头包含"姓名"、"名字"、"name"等字段时，系统应当映射到标准字段name
2. 当表头包含"手机"、"手机号"、"手机号码"、"电话"、"phone"、"mobile"等字段时，系统应当映射到标准字段phone
3. 当表头包含"地址"、"详细地址"、"address"等字段时，系统应当映射到标准字段address
4. 当表头包含"入职日期"、"入职时间"、"日期"、"date"、"hireDate"等字段时，系统应当映射到标准字段hireDate
5. 当表头包含"省"、"省份"、"province"等字段时，系统应当映射到标准字段province
6. 当表头包含"市"、"城市"、"city"等字段时，系统应当映射到标准字段city
7. 当表头包含"区"、"区县"、"district"等字段时，系统应当映射到标准字段district

### 需求 3：基于内容的字段类型识别

**用户故事：** 作为用户，我想要系统在字段名称不明确时，通过分析数据内容来识别字段类型，以便提高识别准确率。

#### 验收标准

1. 当字段名称无法明确识别时，系统应当读取该字段的前10行数据样本
2. 当数据样本中80%以上为11位数字时，系统应当识别为手机号字段
3. 当数据样本中80%以上符合日期格式时，系统应当识别为日期字段
4. 当数据样本中80%以上包含省市区关键词时，系统应当识别为地址字段
5. 当数据样本中80%以上为2-10个汉字时，系统应当识别为姓名字段

### 需求 4：处理未映射字段

**用户故事：** 作为用户，我想要系统能够处理无法映射的字段，以便保留所有原始数据。

#### 验收标准

1. 当某个字段无法映射到标准字段时，系统应当将其作为扩展字段保存
2. 当保存扩展字段时，系统应当使用原始字段名作为键名
3. 当扩展字段数据写入数据库时，系统应当将其序列化为JSON格式存储在extra_fields字段中
4. 当导出数据时，系统应当将扩展字段一并导出

### 需求 5：字段映射配置

**用户故事：** 作为系统管理员，我想要配置字段映射规则，以便支持更多的字段名称变体。

#### 验收标准

1. 当系统启动时，系统应当加载字段映射配置文件
2. 当配置文件包含映射规则时，系统应当使用这些规则进行字段识别
3. 当配置文件更新时，系统应当支持热重载而无需重启服务
4. 当配置文件格式错误时，系统应当使用默认映射规则并记录警告日志
5. 当映射规则包含正则表达式时，系统应当支持正则匹配字段名

### 需求 6：字段映射结果验证

**用户故事：** 作为用户，我想要查看系统识别的字段映射结果，以便确认映射是否正确。

#### 验收标准

1. 当文件上传成功后，系统应当返回识别的字段映射结果
2. 当返回映射结果时，系统应当包含源字段名、标准字段名、映射置信度
3. 当映射置信度低于80%时，系统应当标记为"低置信度"并提示用户确认
4. 当必需字段（姓名、手机号）未能映射时，系统应当返回错误并拒绝处理
5. 当用户确认映射结果后，系统应当开始数据处理

### 需求 7：支持多种字段顺序

**用户故事：** 作为用户，我想要上传字段顺序不同的文件，系统能够正确识别并处理，以便灵活使用不同来源的数据文件。

#### 验收标准

1. 当文件字段顺序为"姓名,手机号,地址,入职日期"时，系统应当正确映射并处理
2. 当文件字段顺序为"手机号,姓名,入职日期,地址"时，系统应当正确映射并处理
3. 当文件字段顺序为"地址,姓名,手机号码,日期"时，系统应当正确映射并处理
4. 当文件包含额外字段时，系统应当将其作为扩展字段保存
5. 当文件缺少某些标准字段时，系统应当将缺失字段标记为null

### 需求 8：字段映射日志

**用户故事：** 作为系统管理员，我想要查看字段映射的详细日志，以便排查映射问题和优化映射规则。

#### 验收标准

1. 当系统进行字段映射时，系统应当记录详细的映射过程日志
2. 当记录日志时，系统应当包含源字段名、候选标准字段、匹配分数、最终映射结果
3. 当映射失败时，系统应当记录失败原因和数据样本
4. 当日志记录完成时，系统应当将日志关联到对应的文件处理任务
5. 当用户查询任务详情时，系统应当返回字段映射日志供查看

### 需求 9：向后兼容

**用户故事：** 作为开发者，我想要新的动态字段映射功能向后兼容现有的固定字段格式，以便不影响现有用户的使用。

#### 验收标准

1. 当上传的文件字段顺序为"姓名,手机号码,地址,入职日期"时，系统应当使用动态映射正确识别
2. 当动态映射功能启用时，系统应当优先使用动态映射而非硬编码映射
3. 当动态映射失败时，系统应当回退到硬编码映射作为兜底方案
4. 当处理历史数据时，系统应当保持与之前相同的处理结果
5. 当系统升级后，现有的API接口应当保持兼容不需要修改

### 需求 10：性能要求

**用户故事：** 作为用户，我想要字段映射过程快速完成，以便不影响整体数据处理性能。

#### 验收标准

1. 当进行字段映射时，系统应当在1秒内完成100个字段的映射识别
2. 当读取数据样本时，系统应当只读取前10行数据而非全部数据
3. 当映射规则较多时，系统应当使用缓存避免重复计算
4. 当处理大文件时，字段映射的时间开销应当小于总处理时间的1%
5. 当并发处理多个文件时，字段映射不应当成为性能瓶颈

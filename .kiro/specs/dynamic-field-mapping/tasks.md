# 实现计划：动态字段映射

## 概述

本实现计划将动态字段映射功能分解为可执行的任务。实现将采用增量方式，先实现核心功能，再逐步添加高级特性。

## 任务

- [ ] 1. 创建字段映射配置和数据模型
  - 创建StandardFieldType枚举定义
  - 创建FieldMapping接口
  - 创建FieldMappingResult接口
  - 创建MappingConfig接口
  - 创建StandardData接口
  - 创建默认字段别名配置
  - _需求: 1.1, 2.1-2.7_

- [ ] 2. 实现HeaderParser（表头解析器）
  - [ ] 2.1 实现parseHeader方法解析CSV第一行
    - 支持逗号分隔的字段
    - 支持带引号的字段名
    - 处理空字段名
    - _需求: 1.1, 1.2_
  
  - [ ] 2.2 实现normalizeFieldName方法标准化字段名
    - 去除前后空格
    - 转换为小写
    - 去除特殊字符
    - _需求: 1.5_
  
  - [ ]* 2.3 编写HeaderParser单元测试
    - 测试各种表头格式
    - 测试字段名标准化
    - _需求: 1.1-1.5_

- [ ] 3. 实现MappingConfigService（映射配置服务）
  - [ ] 3.1 实现loadConfig方法加载配置
    - 加载默认配置
    - 支持从JSON文件加载自定义配置
    - 合并默认配置和自定义配置
    - _需求: 5.1, 5.2_
  
  - [ ] 3.2 实现getAliases方法获取字段别名
    - 返回指定标准字段的所有别名
    - _需求: 2.1-2.7_
  
  - [ ] 3.3 实现addCustomRule方法添加自定义规则
    - 支持添加正则表达式规则
    - 支持设置规则优先级
    - _需求: 5.5_
  
  - [ ]* 3.4 编写MappingConfigService单元测试
    - 测试配置加载
    - 测试别名获取
    - 测试自定义规则
    - _需求: 5.1-5.5_

- [ ] 4. 实现FieldRecognizer（字段识别器）
  - [ ] 4.1 实现recognizeByName方法基于名称识别字段
    - 精确匹配标准字段名
    - 匹配字段别名
    - 正则表达式匹配
    - 模糊匹配（包含关键词）
    - _需求: 2.1-2.7_
  
  - [ ] 4.2 实现getConfidence方法计算置信度
    - 精确匹配：100分
    - 别名匹配：90分
    - 正则匹配：80分
    - 模糊匹配：60分
    - _需求: 6.2, 6.3_
  
  - [ ]* 4.3 编写FieldRecognizer单元测试
    - 测试各种字段名识别
    - 测试置信度计算
    - _需求: 2.1-2.7, 6.2, 6.3_

- [ ] 5. 实现ContentAnalyzer（内容分析器）
  - [ ] 5.1 实现isPhoneNumber方法识别手机号
    - 检查11位数字格式
    - 检查带横杠、空格的手机号格式
    - 计算匹配比例和置信度
    - _需求: 3.2_
  
  - [ ] 5.2 实现isDate方法识别日期
    - 检查各种日期格式
    - 使用日期解析函数验证
    - 计算匹配比例和置信度
    - _需求: 3.3_
  
  - [ ] 5.3 实现isAddress方法识别地址
    - 检查省市区关键词
    - 检查地址长度和中文字符
    - 计算匹配比例和置信度
    - _需求: 3.4_
  
  - [ ] 5.4 实现isName方法识别姓名
    - 检查2-10个汉字
    - 检查中文姓名格式
    - 计算匹配比例和置信度
    - _需求: 3.5_
  
  - [ ] 5.5 实现analyzeContent方法综合分析
    - 调用各个类型检查方法
    - 选择置信度最高的类型
    - 返回识别结果
    - _需求: 3.1_
  
  - [ ]* 5.6 编写ContentAnalyzer单元测试
    - 测试手机号识别
    - 测试日期识别
    - 测试地址识别
    - 测试姓名识别
    - _需求: 3.1-3.5_

- [ ] 6. 实现FieldMappingService（字段映射服务）
  - [ ] 6.1 实现analyzeAndMap方法分析文件并生成映射
    - 解析文件表头
    - 对每个字段进行识别
    - 必要时进行内容分析
    - 生成字段映射结果
    - 记录映射日志
    - _需求: 1.1-1.5, 2.1-2.7, 3.1-3.5_
  
  - [ ] 6.2 实现validateMapping方法验证映射结果
    - 检查必需字段是否已映射
    - 检查映射唯一性
    - 检查置信度是否达标
    - 标记低置信度字段
    - _需求: 6.1-6.5_
  
  - [ ] 6.3 实现applyMapping方法应用映射到数据行
    - 根据列索引映射提取标准字段值
    - 提取未映射字段到extraFields
    - 返回StandardData对象
    - _需求: 7.1-7.5, 4.1-4.3_
  
  - [ ]* 6.4 编写FieldMappingService单元测试
    - 测试完整映射流程
    - 测试映射验证
    - 测试映射应用
    - _需求: 1.1-7.5_

- [ ] 7. 更新数据库schema
  - [ ] 7.1 创建数据库迁移脚本
    - 在clean_data表添加extra_fields字段
    - 设置字段类型为TEXT
    - 添加字段注释
    - _需求: 4.3_
  
  - [ ] 7.2 执行数据库迁移
    - 在开发环境执行迁移
    - 验证字段添加成功
    - _需求: 4.3_

- [ ] 8. 更新Worker线程以支持动态映射
  - [ ] 8.1 修改WorkerMessage接口添加fieldMapping字段
    - 添加FieldMapping类型定义
    - _需求: 7.1-7.5_
  
  - [ ] 8.2 修改parseCsvLine函数使用动态映射
    - 移除硬编码的字段位置
    - 使用fieldMapping.columnIndexMap获取字段值
    - 处理extraFields
    - _需求: 7.1-7.5, 4.1-4.3_
  
  - [ ] 8.3 修改cleanRow函数处理StandardData
    - 适配新的数据结构
    - 处理extraFields的序列化
    - _需求: 4.3_
  
  - [ ] 8.4 修改数据库插入语句包含extra_fields
    - 更新batchInsertCleanData函数
    - 序列化extraFields为JSON字符串
    - _需求: 4.3_

- [ ] 9. 更新ParserService集成字段映射
  - [ ] 9.1 在parseFile方法中调用字段映射
    - 解析文件后立即进行字段映射
    - 将映射结果传递给后续处理
    - _需求: 1.1-2.7_
  
  - [ ] 9.2 修改返回结果包含映射信息
    - 在ParseResult中添加fieldMapping字段
    - 返回映射置信度和日志
    - _需求: 6.1-6.5_

- [ ] 10. 更新Controller返回映射结果
  - [ ] 10.1 修改upload接口返回字段映射信息
    - 在UploadResponseDto中添加fieldMapping字段
    - 返回映射结果供前端展示
    - _需求: 6.1-6.5_
  
  - [ ] 10.2 添加新接口查询字段映射详情
    - 创建GET /api/data-cleaning/mapping/:jobId接口
    - 返回完整的映射日志和置信度信息
    - _需求: 8.1-8.5_

- [ ] 11. 更新ExportService支持扩展字段
  - [ ] 11.1 修改导出逻辑包含extraFields
    - 解析extraFields JSON
    - 将扩展字段添加到导出Excel
    - _需求: 4.4_
  
  - [ ] 11.2 保持字段顺序一致
    - 先输出标准字段
    - 再输出扩展字段
    - _需求: 4.4_

- [ ] 12. 实现配置热重载
  - [ ] 12.1 使用chokidar监听配置文件变化
    - 监听config/field-mapping.json
    - 文件变化时重新加载配置
    - _需求: 5.3_
  
  - [ ] 12.2 添加配置验证
    - 验证JSON格式
    - 验证配置结构
    - 格式错误时使用旧配置
    - _需求: 5.4_

- [ ] 13. 添加向后兼容性支持
  - [ ] 13.1 实现回退机制
    - 当动态映射失败时回退到硬编码映射
    - 记录回退日志
    - _需求: 9.3_
  
  - [ ] 13.2 添加配置开关
    - 添加ENABLE_DYNAMIC_MAPPING环境变量
    - 支持禁用动态映射
    - _需求: 9.1-9.5_

- [ ] 14. 性能优化
  - [ ] 14.1 实现映射结果缓存
    - 使用Map缓存相同表头的映射结果
    - 设置缓存过期时间
    - _需求: 10.3_
  
  - [ ] 14.2 优化内容分析性能
    - 限制样本大小为10行
    - 使用Promise.all并行分析
    - 懒加载内容分析
    - _需求: 10.2, 10.4_
  
  - [ ] 14.3 预编译正则表达式
    - 启动时编译所有正则规则
    - 缓存编译结果
    - _需求: 10.1_

- [ ] 15. 集成测试
  - [ ]* 15.1 测试不同字段顺序的文件
    - 测试"姓名,手机号,地址,入职日期"
    - 测试"手机号,姓名,入职日期,地址"
    - 测试"地址,姓名,手机号码,日期"
    - _需求: 7.1-7.5_
  
  - [ ]* 15.2 测试包含扩展字段的文件
    - 测试额外字段的保存
    - 测试扩展字段的导出
    - _需求: 4.1-4.4_
  
  - [ ]* 15.3 测试向后兼容性
    - 测试标准格式文件的处理
    - 验证结果与之前一致
    - _需求: 9.1-9.5_
  
  - [ ]* 15.4 测试配置更新
    - 测试配置文件修改后的行为
    - 验证热重载生效
    - _需求: 5.3_

- [ ] 16. 性能测试
  - [ ]* 16.1 测试字段映射性能
    - 测试100个字段的映射时间
    - 验证时间<1秒
    - _需求: 10.1_
  
  - [ ]* 16.2 测试大文件处理性能
    - 测试映射对总处理时间的影响
    - 验证影响<1%
    - _需求: 10.4_
  
  - [ ]* 16.3 测试并发性能
    - 测试多个文件同时映射
    - 验证无性能瓶颈
    - _需求: 10.5_

- [ ] 17. 文档更新
  - [ ] 17.1 更新API文档
    - 更新Swagger文档
    - 添加字段映射相关接口说明
    - _需求: 6.1-6.5_
  
  - [ ] 17.2 编写配置文档
    - 说明配置文件格式
    - 提供配置示例
    - 说明如何添加自定义规则
    - _需求: 5.1-5.5_
  
  - [ ] 17.3 更新用户手册
    - 说明动态字段映射功能
    - 提供使用示例
    - 说明如何查看映射结果
    - _需求: 1.1-7.5_

- [ ] 18. 最终检查点
  - 确保所有测试通过
  - 确保性能指标达标
  - 确保向后兼容性
  - 询问用户是否有问题

## 注意事项

- 任务标记为"*"的是可选任务，可以根据时间安排决定是否实施
- 每个任务完成后应该运行相关测试确保功能正常
- 实现过程中如果发现设计问题，应该及时更新设计文档
- 保持代码风格与现有代码一致
- 添加充分的注释和文档

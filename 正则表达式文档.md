# 数据清洗服务 - 正则表达式文档

本文档总结了数据清洗服务项目中使用的所有正则表达式，按功能模块分类整理。

## 目录
- [手机号码验证](#手机号码验证)
- [日期格式识别](#日期格式识别)
- [地址解析](#地址解析)
- [CSV解析](#csv解析)
- [文件类型识别](#文件类型识别)
- [数据类型检测](#数据类型检测)

---

## 手机号码验证

### 基础手机号正则表达式
**文件位置**: `data-cleaning-service/src/common/constants/index.ts`

```javascript
// 中国移动手机号（11位，以1开头，第二位3-9）
export const PHONE_REGEX = {
    MOBILE: /^1[3-9]\d{9}$/,
    LANDLINE: /^\d{7,12}$/
};
```

### 手机号清洗正则表达式
**文件位置**: `data-cleaning-service/src/services/phone-cleaner.service.ts`

```javascript
// 移除非数字字符（保留开头的+号）
cleaned = cleaned.replace(/\D/g, '');

// 验证11位手机号格式
/^\d{11}$/.test(phone)

// 验证本地固话（7-8位，不能以0或1开头）
/^[2-9]\d{6,7}$/.test(phone)

// 验证带区号固话（10-12位，必须以0开头）
/^0\d{9,11}$/.test(phone)
```

**用途说明**:
- `MOBILE`: 验证中国移动手机号格式
- `LANDLINE`: 验证固定电话号码格式
- `/\D/g`: 移除所有非数字字符
- `/^[2-9]\d{6,7}$/`: 本地固话验证
- `/^0\d{9,11}$/`: 带区号固话验证

---

## 日期格式识别

### 数字格式检测
**文件位置**: `data-cleaning-service/src/services/date-cleaner.service.ts`

```javascript
// Excel序列号检测（纯数字或小数）
/^\d+(\.\d+)?$/.test(dateStr)

// Unix时间戳（秒）- 10位数字
/^\d{10}$/.test(dateStr)

// Unix时间戳（毫秒）- 13位数字
/^\d{13}$/.test(dateStr)
```

### ISO日期格式
```javascript
// ISO格式数组
const isoPatterns = [
    /^(\d{4})-(\d{1,2})-(\d{1,2})$/,                    // YYYY-MM-DD
    /^(\d{4})\/(\d{1,2})\/(\d{1,2})$/,                  // YYYY/MM/DD
    /^(\d{4})-(\d{1,2})-(\d{1,2})\s+\d{1,2}:\d{1,2}(:\d{1,2})?/, // YYYY-MM-DD HH:MM:SS
    /^(\d{4})\/(\d{1,2})\/(\d{1,2})\s+\d{1,2}:\d{1,2}(:\d{1,2})?/  // YYYY/MM/DD HH:MM:SS
];
```

### 美式日期格式
```javascript
// 美式格式数组
const americanPatterns = [
    /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/,  // MM/DD/YYYY
    /^(\d{1,2})-(\d{1,2})-(\d{4})$/     // MM-DD-YYYY
];
```

### 中文日期格式
```javascript
// 中文格式数组
const chinesePatterns = [
    /^(\d{4})年(\d{1,2})月(\d{1,2})日$/,  // YYYY年MM月DD日
    /^(\d{4})年(\d{1,2})月(\d{1,2})$/     // YYYY年MM月DD日（无"日"）
];
```

**用途说明**:
- 支持多种日期格式的自动识别和转换
- 处理Excel序列号、Unix时间戳等特殊格式
- 支持中文、美式、ISO等不同地区的日期格式

---

## 地址解析

### 城市匹配正则表达式
**文件位置**: `data-cleaning-service/src/services/address-cleaner.service.ts`

```javascript
// 特殊城市模式1：处理"青岛市市南区"类型
const specialPattern1 = /^([\u4e00-\u9fff]{2,8}市)市([\u4e00-\u9fff]{1,4}区)/;

// 特殊城市模式2：处理"广州市越秀区"类型
const specialPattern2 = /^([\u4e00-\u9fff]{2,8}市)([\u4e00-\u9fff]{2,6}区)/;

// 常规城市匹配模式
const cityPatterns = [
    /^([\u4e00-\u9fff]{2,8}市)/,                    // 以"市"结尾的城市名
    /^([\u4e00-\u9fff]{2,12}(自治州|地区|盟))/      // 自治州、地区、盟
];
```

### 行政区划匹配
```javascript
// 区县匹配模式
const districtPatterns = [
    /^((?!.*风景)[\u4e00-\u9fff]{2,6}区)/,  // 区（排除风景区）
    /^([\u4e00-\u9fff]{2,6}县)/,            // 县
    /^([\u4e00-\u9fff]{2,6}市)/,            // 县级市
    /^([\u4e00-\u9fff]{2,8}旗)/             // 旗（内蒙古）
];

// 省份后缀移除
province.replace(/(省|市|自治区|特别行政区)$/, '')
```

**用途说明**:
- `[\u4e00-\u9fff]`: 匹配中文字符范围
- 特殊模式处理城市名与区名连接的情况
- 排除风景区等非行政区划
- 支持各种行政级别（省、市、区、县、旗等）

---

## CSV解析

### 乱码检测
**文件位置**: `data-cleaning-service/src/services/parser.service.ts`

```javascript
// 乱码检测模式
const garbledPatterns = [
    /[��]/g,                                    // 常见乱码字符
    /[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g       // 控制字符
];
```

**用途说明**:
- 检测CSV文件中的编码问题
- 识别常见的乱码字符和控制字符

---

## 文件类型识别

### 数据类型检测正则表达式
**文件位置**: `data-cleaning-service/src/services/parser.service.ts`

```javascript
// 手机号格式检测
const cleaned = value.replace(/[\s\-\(\)\.]/g, '');  // 移除分隔符
if (!/^\d+$/.test(cleaned)) {                        // 检查是否全为数字
    return false;
}

// 日期格式检测数组
const datePatterns = [
    /^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}$/,      // YYYY-MM-DD 或 YYYY/MM/DD
    /^\d{4}年\d{1,2}月\d{1,2}日$/,          // YYYY年MM月DD日
    /^\d{1,2}[-\/]\d{1,2}[-\/]\d{4}$/,      // MM/DD/YYYY 或 MM-DD-YYYY
    /^\d{4}\d{2}\d{2}$/                     // YYYYMMDD
];

// 数字检测
/^-?\d+(\.\d+)?$/.test(value.trim())        // 整数或小数（含负数）
```

### 地址关键词检测
```javascript
// 地址关键词数组
const addressKeywords = [
    '省', '市', '区', '县', '街道', '路', '号', '村', '镇', '乡',
    '北京', '上海', '天津', '重庆', '广东', '浙江', '江苏', '山东',
    '河南', '河北', '湖南', '湖北', '四川', '福建', '安徽', '江西',
    '辽宁', '黑龙江', '吉林', '山西', '陕西', '甘肃', '青海', '宁夏',
    '新疆', '西藏', '内蒙古', '广西', '海南', '贵州', '云南'
];
```

**用途说明**:
- 自动识别列的数据类型（手机号、日期、地址、数字、文本）
- 基于表头名称和数据内容的双重检测
- 支持多种格式的模糊匹配

---

## 数据类型检测

### 表头关键词检测
**文件位置**: `data-cleaning-service/src/services/parser.service.ts`

```javascript
// 手机号表头关键词
const phoneKeywords = ['手机', '电话', 'phone', 'mobile', 'tel', '联系方式', '联系电话'];

// 日期表头关键词
const dateKeywords = ['日期', '时间', 'date', 'time', '创建时间', '更新时间', '生日', '出生日期'];

// 地址表头关键词
const addressKeywords = ['地址', '住址', 'address', '省', '市', '区', '县', '街道', '详细地址'];
```

**用途说明**:
- 基于表头名称进行数据类型预判
- 支持中英文关键词识别
- 提高数据类型识别的准确性

---

## 正则表达式使用规范

### 1. 性能优化
- 使用非捕获组 `(?:...)` 当不需要捕获内容时
- 避免过度使用量词 `*` 和 `+`
- 使用字符类 `[...]` 替代多个选择 `|`

### 2. 可读性
- 复杂正则表达式添加注释说明
- 使用有意义的变量名存储正则表达式
- 将长正则表达式拆分为多个部分

### 3. 国际化支持
- 使用Unicode字符范围 `[\u4e00-\u9fff]` 匹配中文
- 考虑不同地区的格式差异
- 提供多语言关键词支持

### 4. 错误处理
- 使用 `try-catch` 包装正则表达式操作
- 提供默认值和降级处理
- 记录匹配失败的情况用于调试

---

## 测试用例

### 手机号测试
```javascript
// 有效手机号
"13812345678"     // ✓ 标准格式
"138-1234-5678"   // ✓ 带分隔符
"138 1234 5678"   // ✓ 空格分隔

// 无效手机号
"1381234567"      // ✗ 位数不足
"12812345678"     // ✗ 不以1开头
"13912345678901"  // ✗ 位数过多
```

### 日期测试
```javascript
// 有效日期
"2023-01-15"      // ✓ ISO格式
"2023年1月15日"   // ✓ 中文格式
"01/15/2023"      // ✓ 美式格式
"20230115"        // ✓ 紧凑格式

// 无效日期
"2023-13-01"      // ✗ 月份无效
"2023年2月30日"   // ✗ 日期无效
"23/01/15"        // ✗ 年份格式错误
```

### 地址测试
```javascript
// 有效地址
"北京市朝阳区建国路1号"           // ✓ 完整地址
"山东省青岛市市南区香港中路68号"   // ✓ 特殊城市格式
"广东省广州市越秀区环市东路339号"  // ✓ 标准格式

// 问题地址
"北京朝阳区"                     // ⚠ 缺少详细信息
"某某路123号"                    // ⚠ 缺少省市信息
```

---

## 维护说明

1. **添加新的正则表达式时**:
   - 在对应的服务文件中添加
   - 更新本文档
   - 添加相应的测试用例
   - 考虑性能影响

2. **修改现有正则表达式时**:
   - 确保向后兼容性
   - 运行完整的测试套件
   - 更新相关文档
   - 评估对现有数据的影响

3. **性能监控**:
   - 定期检查正则表达式的执行时间
   - 优化复杂的匹配模式
   - 考虑使用缓存机制

---

*最后更新时间: 2026年1月9日*
*版本: 1.0.0*